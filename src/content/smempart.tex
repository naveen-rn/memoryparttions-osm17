\section{Symmetric Memory Partitions in OpenSHMEM}
\label{src:smempart}

As mentioned in Section~\ref{src:bg/mmodel}, the OpenSHMEM memory
model allows creation of one symmetric heap per PE during program
execution on a memory region determined by the implementation. The
only trait the user controls on the symmetric heap is the size. This
paper proposes a new feature called Symmetric Memory Partitions to
define the runtime changes and extensions to support different kinds
of memory for the symmetric heap.

Symmetric Heap is created on a single memory location determined by
the implementation or at multiple memory regions determined by the
users. The user-determined memory region are called as the Symmetric
Memory Partitions. Only a single symmetric heap is created at each
symmetric memory partition. Each symmetric memory partition is
identified using its \emph{Partition ID}, which is used in dynamic
OpenSHMEM memory allocation extensions. Apart from the Partition ID,
each symmetric memory partition have their own memory traits to define
the characteristics of a memory partition. Multiple symmetric heaps
can be created by defining multiple separate memory partitions. Apart
from name, data type, and size attributes, symmetric data objects
stored on symmetric heaps created over a memory partition have
Partition ID as an extra attribute.

\subsection{Memory Partition Traits}
\label{src:smempart/traits}
The characteristics of each symmetric memory partition is uniform
across all PEs and is defined using the environmental variable
\texttt{SHMEM\_SYMMETRIC\_PARTITION}. The characteristics of these
partitions are established using the following required and some
optional traits.
\begin{itemize}
    \item \emph{Partition ID} is the required trait represented as
    an integer to identify the partition;
    \texttt{SHMEM\_MAX\_PARTITION\_ID} is the library constant used
    to determine the maximum value that can be used to represent
    the partition ID;
    \item \emph{SIZE} is one of another required traits to
    represent the number of bytes to allocate for symmetric heap;
    \item \emph{PGSIZE} is an optional trait to represent the
    number of bytes used to specify the size of the page used by
    the partition;
    \item \emph{KIND} is another optional trait, identified with a
    string constant to specify the kind of memory is multiple memory
    kinds are supported by the system and identified by the
    implementation; and
    \item \emph{POLICY} is an optional trait and identified using
    string constants to represent the memory allocation policy for
    the partition.
\end{itemize}

\begin{figure}
    \lstset{language=c,
            keywordstyle=\bfseries,
            basicstyle=\tt\small,
            frame=single}
    \begin{lstlisting}
SHMEM_SYMMETRIC_PARTITION<ID>=SIZE=<size>[:PGSIZE=<pgsize>]
                             [:KIND=<kind>:POLICY=<policy>]
    \end{lstlisting}
    \caption{Environmental Variable to define the Partition
    Characteristics}
    \label{fig:env}
\end{figure}
Figure~\ref{fig:env} shows the representaton of the
\texttt{SHMEM\_SYMMETRIC\_PARTITION} environmental variable with
all its optional and required traits.

\subsubsection{Required Partition Traits}
\label{src:smempart/req}
One, two, or more partitions
can be specified using this environment variable. Each partition is
represented using a number called Partition ID. In
Figure~\ref{fig:env},\textless ID\textgreater is the user-specified
part of the environment variable to represent the Partition ID. A
maximum of \texttt{SHMEM\_MAX\_PARTITIONS} can be defined. These
defined partitions can have any non-zero positive integer between
1 and \texttt{SHMEM\_MAX\_PARTITION\_ID} as Partition ID. Each
partition takes a maximum of four traits as input.

The SIZE is the only required trait. It is used to specify the required
symmetric heap size on the partition. The total size of the symmetric heap
is determined as the sum of all SIZE traits in the defined memory
partitions.

\subsubsection{Optional Partition Traits}
\label{src:smempart/optional}
The PGSIZE trait is used to specify the size of page used by the partition.
The KIND trait is used to specify the memory kind used by the partition.
On systems supporting multiple different kinds of memory, each memory
that is identified and documented by the implementation can used as input
to represent the KIND.

When the optional traits are used to define the characteristics of the
partition, the POLICY trait is used to determine the strictness level
the optional traits are to be honoured by the implemantation. Mandatory,
preferred, system default and interleaved are some examples of the
values to the POLICY option.

\subsection{Memory Partition Extensions}
\label{src:smempart/extensions}
\texttt{shmem\_malloc}, \texttt{shmem\_free}, \texttt{shmem\_realloc},
and \texttt{shmem\_align} are the existing symmetric heap management
routines. Apart from these existing routines, as part of the runtime
changes to support symmetric heap partitions, this paper proposes the
following two symmetric heap management routines identified using the
symmetric memory partition ID: \texttt{shmem\_partition\_malloc} and
\texttt{shmem\_partition\_align}.

\begin{figure}
    \lstset{language=c,
            keywordstyle=\bfseries,
            basicstyle=\tt\small,
            frame=single}
    \begin{lstlisting}
void *shmem_partition_malloc(size_t size, int partition_id);
void *shmem_partiton_align(size_t alignment, size_t size,
                           int partition_id);
    \end{lstlisting}
    \caption{New extensions for Symmetric Heap Management}
    \label{fig:extensions}
\end{figure}

The functional semantics and the requirements of
\texttt{shmem\_partition\_malloc} and \texttt{shmem\_partition\_align}
are very similar to \texttt{shmem\_malloc} and \texttt{shmem\_align},
the only difference being the new extensions allows the users to
determine the symmetric heap on the partitions they were created using
the partiton ID argument.

\begin{figure}[!h]
    \vspace{-20pt}
    \hspace*{5mm}
    \includegraphics[scale=0.20]{image/smem-model.png}
    \vspace{-25pt}
    \caption{OpenSHMEM Memory Model with Symmetric Memory Partitions}
    \label{fig:smem-model}
\end{figure}

